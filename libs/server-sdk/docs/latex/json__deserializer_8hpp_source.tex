\doxysection{json\+\_\+deserializer.\+hpp}
\hypertarget{json__deserializer_8hpp_source}{}\label{json__deserializer_8hpp_source}\index{src/data\_components/serialization\_adapters/json\_deserializer.hpp@{src/data\_components/serialization\_adapters/json\_deserializer.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{00001\ \textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{00002\ }
\DoxyCodeLine{00003\ \textcolor{preprocessor}{\#include\ "{}../../../include/launchdarkly/server\_side/integrations/data\_reader/kinds.hpp"{}}}
\DoxyCodeLine{00004\ \textcolor{preprocessor}{\#include\ "{}../../data\_interfaces/source/idata\_reader.hpp"{}}}
\DoxyCodeLine{00005\ }
\DoxyCodeLine{00006\ \textcolor{preprocessor}{\#include\ <launchdarkly/logging/logger.hpp>}}
\DoxyCodeLine{00007\ \textcolor{preprocessor}{\#include\ <launchdarkly/serialization/value\_mapping.hpp>}}
\DoxyCodeLine{00008\ \textcolor{preprocessor}{\#include\ <launchdarkly/server\_side/integrations/data\_reader/iserialized\_data\_reader.hpp>}}
\DoxyCodeLine{00009\ }
\DoxyCodeLine{00010\ \textcolor{preprocessor}{\#include\ <memory>}}
\DoxyCodeLine{00011\ }
\DoxyCodeLine{00012\ \textcolor{keyword}{namespace\ }launchdarkly\ \{}
\DoxyCodeLine{00013\ }
\DoxyCodeLine{00014\ tl::expected<std::optional<data\_model::Tombstone>,\ JsonError>\ tag\_invoke(}
\DoxyCodeLine{00015\ \ \ \ \ boost::json::value\_to\_tag<tl::expected<std::optional<data\_model::Tombstone>,}
\DoxyCodeLine{00016\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ JsonError>>\ \textcolor{keyword}{const}\&\ unused,}
\DoxyCodeLine{00017\ \ \ \ \ boost::json::value\ \textcolor{keyword}{const}\&\ json\_value);}
\DoxyCodeLine{00018\ \}\ \ \textcolor{comment}{//\ namespace\ launchdarkly}}
\DoxyCodeLine{00019\ }
\DoxyCodeLine{00020\ \textcolor{keyword}{namespace\ }launchdarkly::server\_side::data\_components\ \{}
\DoxyCodeLine{00021\ }
\DoxyCodeLine{00022\ \textcolor{keyword}{class\ }\mbox{\hyperlink{classlaunchdarkly_1_1server__side_1_1data__components_1_1JsonDeserializer}{JsonDeserializer}}\ final\ :\ \textcolor{keyword}{public}\ \mbox{\hyperlink{classlaunchdarkly_1_1server__side_1_1data__interfaces_1_1IDataReader}{data\_interfaces::IDataReader}}\ \{}
\DoxyCodeLine{00023\ \ \ \ \textcolor{keyword}{public}:}
\DoxyCodeLine{00024\ \ \ \ \ \textcolor{keyword}{explicit}\ \mbox{\hyperlink{classlaunchdarkly_1_1server__side_1_1data__components_1_1JsonDeserializer}{JsonDeserializer}}(}
\DoxyCodeLine{00025\ \ \ \ \ \ \ \ \ Logger\ \textcolor{keyword}{const}\&\ logger,}
\DoxyCodeLine{00026\ \ \ \ \ \ \ \ \ std::shared\_ptr<integrations::ISerializedDataReader>\ reader);}
\DoxyCodeLine{00027\ }
\DoxyCodeLine{00028\ \ \ \ \ [[nodiscard]]\ SingleResult<data\_model::Flag>\ \mbox{\hyperlink{classlaunchdarkly_1_1server__side_1_1data__components_1_1JsonDeserializer_ad777d037598e3daf83f7186470f247ce}{GetFlag}}(}
\DoxyCodeLine{00029\ \ \ \ \ \ \ \ \ std::string\ \textcolor{keyword}{const}\&\ key)\ \textcolor{keyword}{const\ override};}
\DoxyCodeLine{00030\ }
\DoxyCodeLine{00031\ \ \ \ \ [[nodiscard]]\ SingleResult<data\_model::Segment>\ \mbox{\hyperlink{classlaunchdarkly_1_1server__side_1_1data__components_1_1JsonDeserializer_a3d9635a688556b2833772679aeb4f09c}{GetSegment}}(}
\DoxyCodeLine{00032\ \ \ \ \ \ \ \ \ std::string\ \textcolor{keyword}{const}\&\ key)\ \textcolor{keyword}{const\ override};}
\DoxyCodeLine{00033\ }
\DoxyCodeLine{00034\ \ \ \ \ [[nodiscard]]\ CollectionResult<data\_model::Flag>\ \mbox{\hyperlink{classlaunchdarkly_1_1server__side_1_1data__components_1_1JsonDeserializer_af56a404a65c80d1e88ae9558cbd71e2f}{AllFlags}}()\ \textcolor{keyword}{const\ override};}
\DoxyCodeLine{00035\ }
\DoxyCodeLine{00036\ \ \ \ \ [[nodiscard]]\ CollectionResult<data\_model::Segment>\ \mbox{\hyperlink{classlaunchdarkly_1_1server__side_1_1data__components_1_1JsonDeserializer_a4405056781725bc8de32e288720bd07b}{AllSegments}}()}
\DoxyCodeLine{00037\ \ \ \ \ \ \ \ \ \textcolor{keyword}{const\ override};}
\DoxyCodeLine{00038\ }
\DoxyCodeLine{00039\ \ \ \ \ [[nodiscard]]\ std::string\ \textcolor{keyword}{const}\&\ \mbox{\hyperlink{classlaunchdarkly_1_1server__side_1_1data__components_1_1JsonDeserializer_ab0f83b11c0f245d50ff208b562c75857}{Identity}}()\ \textcolor{keyword}{const\ override};}
\DoxyCodeLine{00040\ }
\DoxyCodeLine{00041\ \ \ \ \ [[nodiscard]]\ \textcolor{keywordtype}{bool}\ \mbox{\hyperlink{classlaunchdarkly_1_1server__side_1_1data__components_1_1JsonDeserializer_a8e84e2ab0430e00570ebbe4abdd2db24}{Initialized}}()\ \textcolor{keyword}{const\ override};}
\DoxyCodeLine{00042\ }
\DoxyCodeLine{00043\ \ \ \ \textcolor{keyword}{private}:}
\DoxyCodeLine{00044\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ Item>}
\DoxyCodeLine{00045\ \ \ \ \ \textcolor{keyword}{static}\ tl::expected<data\_model::ItemDescriptor<Item>,}
\DoxyCodeLine{00046\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ data\_interfaces::IDataReader::Error>}
\DoxyCodeLine{00047\ \ \ \ \ DeserializeJsonDescriptor(}
\DoxyCodeLine{00048\ \ \ \ \ \ \ \ \ \mbox{\hyperlink{structlaunchdarkly_1_1server__side_1_1integrations_1_1SerializedItemDescriptor}{integrations::SerializedItemDescriptor}}\ \textcolor{keyword}{const}\&\ descriptor)\ \{}
\DoxyCodeLine{00049\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (descriptor.\mbox{\hyperlink{structlaunchdarkly_1_1server__side_1_1integrations_1_1SerializedItemDescriptor_aee2e7e1caa4461486044b79abdb8fa28}{deleted}})\ \{}
\DoxyCodeLine{00050\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ data\_model::ItemDescriptor<Item>(}
\DoxyCodeLine{00051\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ data\_model::Tombstone(descriptor.version));}
\DoxyCodeLine{00052\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00053\ }
\DoxyCodeLine{00054\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \textcolor{keyword}{const}\ json\_val\ =\ boost::json::parse(descriptor.serializedItem);}
\DoxyCodeLine{00055\ }
\DoxyCodeLine{00056\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (\textcolor{keyword}{auto}\ item\_result\ =\ boost::json::value\_to<}
\DoxyCodeLine{00057\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tl::expected<std::optional<Item>,\ JsonError>>(json\_val))\ \{}
\DoxyCodeLine{00058\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ item\ =\ *item\_result;}
\DoxyCodeLine{00059\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!item)\ \{}
\DoxyCodeLine{00060\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tl::make\_unexpected(\textcolor{stringliteral}{"{}item\ invalid:\ value\ is\ null"{}});}
\DoxyCodeLine{00061\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00062\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ data\_model::ItemDescriptor<Item>(std::move(*item));}
\DoxyCodeLine{00063\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00064\ }
\DoxyCodeLine{00065\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ tombstone\ =\ boost::json::value\_to<}
\DoxyCodeLine{00066\ \ \ \ \ \ \ \ \ \ \ \ \ tl::expected<std::optional<data\_model::Tombstone>,\ JsonError>>(}
\DoxyCodeLine{00067\ \ \ \ \ \ \ \ \ \ \ \ \ json\_val);}
\DoxyCodeLine{00068\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!tombstone)\ \{}
\DoxyCodeLine{00069\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tl::make\_unexpected(ErrorToString(tombstone.error()));}
\DoxyCodeLine{00070\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00071\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ tombstone\_result\ =\ *tombstone;}
\DoxyCodeLine{00072\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!tombstone\_result)\ \{}
\DoxyCodeLine{00073\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tl::make\_unexpected(\textcolor{stringliteral}{"{}tombstone\ invalid:\ value\ is\ null"{}});}
\DoxyCodeLine{00074\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00075\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ data\_model::ItemDescriptor<Item>(*tombstone\_result);}
\DoxyCodeLine{00076\ \ \ \ \ \}}
\DoxyCodeLine{00077\ }
\DoxyCodeLine{00078\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ DataModel,\ \textcolor{keyword}{typename}\ DataKind>}
\DoxyCodeLine{00079\ \ \ \ \ SingleResult<DataModel>\ DeserializeSingle(DataKind\ \textcolor{keyword}{const}\&\ kind,}
\DoxyCodeLine{00080\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ std::string\ \textcolor{keyword}{const}\&\ key)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00081\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ result\ =\ source\_-\/>Get(kind,\ key);}
\DoxyCodeLine{00082\ }
\DoxyCodeLine{00083\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!result)\ \{}
\DoxyCodeLine{00084\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ error\ in\ fetching\ the\ item\ */}}
\DoxyCodeLine{00085\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tl::make\_unexpected(result.error().message);}
\DoxyCodeLine{00086\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00087\ }
\DoxyCodeLine{00088\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ serialized\_item\ =\ *result;}
\DoxyCodeLine{00089\ }
\DoxyCodeLine{00090\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!serialized\_item)\ \{}
\DoxyCodeLine{00091\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ std::nullopt;}
\DoxyCodeLine{00092\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00093\ }
\DoxyCodeLine{00094\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ DeserializeJsonDescriptor<DataModel>(*serialized\_item);}
\DoxyCodeLine{00095\ \ \ \ \ \}}
\DoxyCodeLine{00096\ }
\DoxyCodeLine{00097\ \ \ \ \ \textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ DataModel,\ \textcolor{keyword}{typename}\ DataKind>}
\DoxyCodeLine{00098\ \ \ \ \ CollectionResult<DataModel>\ DeserializeCollection(}
\DoxyCodeLine{00099\ \ \ \ \ \ \ \ \ DataKind\ \textcolor{keyword}{const}\&\ kind)\textcolor{keyword}{\ const\ }\{}
\DoxyCodeLine{00100\ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ result\ =\ source\_-\/>All(kind);}
\DoxyCodeLine{00101\ }
\DoxyCodeLine{00102\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!result)\ \{}
\DoxyCodeLine{00103\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{/*\ error\ in\ fetching\ the\ items\ */}}
\DoxyCodeLine{00104\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ tl::make\_unexpected(result.error().message);}
\DoxyCodeLine{00105\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00106\ }
\DoxyCodeLine{00107\ \ \ \ \ \ \ \ \ Collection<DataModel>\ items;}
\DoxyCodeLine{00108\ }
\DoxyCodeLine{00109\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keyword}{auto}\ \textcolor{keyword}{const}\&\ [key,\ descriptor]\ :\ *result)\ \{}
\DoxyCodeLine{00110\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ item\ =\ DeserializeJsonDescriptor<DataModel>(descriptor);}
\DoxyCodeLine{00111\ }
\DoxyCodeLine{00112\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (!item)\ \{}
\DoxyCodeLine{00113\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ LD\_LOG(logger\_,\ LogLevel::kError)}
\DoxyCodeLine{00114\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ \textcolor{stringliteral}{"{}failed\ to\ deserialize\ "{}}\ <<\ key\ <<\ \textcolor{stringliteral}{"{}\ while\ fetching\ all\ "{}}}
\DoxyCodeLine{00115\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ <<\ kind.Namespace()\ <<\ \textcolor{stringliteral}{"{}:\ "{}}\ <<\ item.error();}
\DoxyCodeLine{00116\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{continue};}
\DoxyCodeLine{00117\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00118\ }
\DoxyCodeLine{00119\ \ \ \ \ \ \ \ \ \ \ \ \ items.emplace(key,\ *item);}
\DoxyCodeLine{00120\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{00121\ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ items;}
\DoxyCodeLine{00122\ \ \ \ \ \}}
\DoxyCodeLine{00123\ }
\DoxyCodeLine{00124\ \ \ \ \ Logger\ \textcolor{keyword}{const}\&\ logger\_;}
\DoxyCodeLine{00125\ \ \ \ \ \mbox{\hyperlink{classlaunchdarkly_1_1server__side_1_1integrations_1_1FlagKind}{integrations::FlagKind}}\ \textcolor{keyword}{const}\ flag\_kind\_;}
\DoxyCodeLine{00126\ \ \ \ \ \mbox{\hyperlink{classlaunchdarkly_1_1server__side_1_1integrations_1_1SegmentKind}{integrations::SegmentKind}}\ \textcolor{keyword}{const}\ segment\_kind\_;}
\DoxyCodeLine{00127\ \ \ \ \ std::shared\_ptr<integrations::ISerializedDataReader>\ source\_;}
\DoxyCodeLine{00128\ \ \ \ \ std::string\ \textcolor{keyword}{const}\ identity\_;}
\DoxyCodeLine{00129\ \};}
\DoxyCodeLine{00130\ }
\DoxyCodeLine{00131\ \}\ \ \textcolor{comment}{//\ namespace\ launchdarkly::server\_side::data\_components}}

\end{DoxyCode}
